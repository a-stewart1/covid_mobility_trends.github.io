---
title: 
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
---

# __COVID-19 Mobility Trends in NYC__:
## An Exploration of the Impact of the COVID-19 Pandemic on Mobility as Measured by MTA Ridership

*Contributors: Julián Ponce, Michelle Lee, Adarsh Ramakrishnan, Allison Stewart, Aishwarya Anuraj*

### Motivation

The central artery of New York City, the public transportation system is central to the cultural and economic well-being. Among its usual million daily users such as hip hop dancers, Wall Street executives, and the famous [pizza rat](https://www.cnn.com/2015/09/22/living/pizza-rat-feat/index.html), the subway proves to be more than a means of transport; it is a way of life. 

  Unfortunately, the COVID-19 pandemic and the “New York State on PAUSE” executive order, issued on March 14, 2020 aimed to slow the spread of the virus, brought tremendous shock to the normal bustle of New York City. Closed museums, theaters, restaurants, and suspended commutes have created ghost town-like scenes and some people to proclaim that New York City is [“over”](https://www.nytimes.com/2020/08/25/nyregion/nyc-coronavirus-reopening.html?searchResultPosition=43) as we know it. 

  This project moves forward with the aim of understanding the influence of the COVID-19 pandemic on human mobility trends in NYC as measured by MTA ridership on subway trains and buses from March to December 2019 and 2020.  

### Related work

  Understanding trends in ridership is important as it may be associated with COVID-19 transmission as well as economic implications such as consumer spending. [Past studies](https://covid-mobility.stanford.edu/) have predicted higher infection rates among disadvantaged racial and socioeconomic groups solely from differences in mobility data. [Simlar studies](https://visualization.covid19mobility.org/?date=2020-11-26&dates=2020-08-26_2020-11-26&region=36) have focused on mobility trends at the county level and fail to look at mobility trends by sector. Our study adds to this important topic as it compares mobility trends by means of transportation (bus, subway). 

  Understanding this important issue could provide insight to policymakers, transit authorities, and health departments as they make decisions related to transmission of COVID-19 and modifications to public transportation systems in light of stay-at-home orders.
  
### Research Questions 

* Does average MTA subway ridership March-December 2019 differ from average MTA subway ridership March-December 2020?
* Does subway ridership differ from bus ridership during the COVID-19 pandemic (March to December 2020)?

We initially wanted to explore mobility trends by borough and expand our means of transportation to air traffic. However, we did not find adequate information on mobility trends at the borough level and realized that adding air traffic would be a bit overwhelming for the scope of this project. We identified Apple Mobility Trend data as a potential source but ultimately decided to use MTA data due to more appropriate variables. The Apple data only provided percentage change values and not the crude number of ridership, which was important for our visualization and statistical tests. Additionally, we expected to explore trends for the whole calendar year and were limited by only having available data from March to December. 


### Data

#### Data Source 

We used a publicly available [dataset](https://new.mta.info/coronavirus/ridership) on day-by-day ridership numbers  from the MTA. The dataset contains information on total estimated ridership and percentage change from 2019 by day, beginning March 1, 2020. Estimates of ridership by subway, bus (local, limited, SBS, and Express), Long Island Rail Road, Metro-North Railroad, Access-A-Ride, and Bridges and Tunnels are all available, however, we decided to restrict our analysis to subway and bus ridership.   

The dataset was downloaded as a .csv files and imported into RStudio. We then cleaned the variables names, verified that there were no missing values, and excluded the variables on the Long Island Rail Road, Metro-North Railroad, Access-A-Ride, and Bridges and Tunnels, which we did not plan to include in further data visualization and analysis.


#### Data Cleaning 

The dataset was downloaded as a .csv file and imported into RStudio. We then cleaned the variables names, verified that there were no missing values, and excluded the variables on the Long Island Rail Road, Metro-North Railroad, Access-A-Ride, and Bridges and Tunnels, which we did not plan to include in further data visualization and analysis. 

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(readr)
library(broom)
library(dbplyr)
library(viridis)
library(reshape2)
library(plotly)
library(lubridate)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


```{r, results=FALSE}
mta_data = read_csv (file = "./data/MTA_recent_ridership_data_20201123_0.csv",
                     col_types = cols(
                       date = col_date(format = "%mm/%dd/%yy"),
                       `Subways: % Change From 2019 Equivalent Day` = col_number(),
                       `Buses: % Change From 2019 Equivalent Day` = col_number(),
                       `Bridges and Tunnels: % Change From 2019 Equivalent Day` = col_number()
                       ) #only changed the formats of important variables 
) %>%
  janitor::clean_names()
skimr::skim(mta_data)
mta_data =
  mta_data %>%
  subset(select = -c(lirr_total_estimated_ridership, lirr_percent_change_from_2019_monthly_weekday_saturday_sunday_average, metro_north_total_estimated_ridership, metro_north_percent_change_from_2019_monthly_weekday_saturday_sunday_average, access_a_ride_total_scheduled_trips, access_a_ride_percent_change_from_2019_monthly_weekday_saturday_sunday_average, bridges_and_tunnels_total_traffic, bridges_and_tunnels_percent_change_from_2019_equivalent_day))
#exclude data for lirr, metronorth, access-a-ride, bridges & tunnel
```

Next, we calculated the 2019 ridership estimates for subway and buses based on the 2020 estimates and percentage change data. The 2019 estimates were calculated by (1) changing the percent change to decimal, (2) adding 1, (3) dividing 2020 ridership by the resulting value from step 2 to produce the 2019 ridership estimate.

```{r}
mta_data = mta_data %>%
  mutate( 
    'subway_2019' = subways_total_estimated_ridership/(1+(subways_percent_change_from_2019_equivalent_day/100)),
    'bus_2019'=
      buses_total_estimated_ridership/(1+(buses_percent_change_from_2019_equivalent_day/100))
    ) %>%
  rename(
    "subway_2020" = subways_total_estimated_ridership,
    "subway_pct_change" = subways_percent_change_from_2019_equivalent_day,
    "bus_2020" = buses_total_estimated_ridership,
    "bus_pct_change" = buses_percent_change_from_2019_equivalent_day
    )
```

### Exploratory Analysis 

We first implemented an exploratory analysis of subway and bus MTA ridership trends in 2019 and 2020.  

After initial data cleaning, we changed the date from character to date format and then created a text_label dataset to show percent change from 2019-2020 when hovered on the graph. Then, we created a dataset with variables related to subway and pivoted it so it could be correctly graphed by year. We then merged the subway database with the text_label dataset. Then using plotly, we plotted the general trends of subway ridership per day from March - November. To visualize the ridership trends within the context of the COVID-19 pandemic, we added vertical lines that indicate the first diagnosed COVID-19 case in New York City (3/1/2020), and the days NYC cumulative cases hit 100,000 (04/07) and 200,000 (05/26).

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(readr)
library(broom)
library(dbplyr)
library(viridis)
library(reshape2)
library(plotly)
library(lubridate)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r include=FALSE}
mta_data = read_csv (file = "./data/MTA_recent_ridership_data_20201123_0.csv",
                     col_types = cols(
                       date = col_date(format = "%mm/%dd/%yy"),
                       `Subways: % Change From 2019 Equivalent Day` = col_number(),
                       `Buses: % Change From 2019 Equivalent Day` = col_number(),
                       `Bridges and Tunnels: % Change From 2019 Equivalent Day` = col_number()
                       ) #only changed the formats of important variables 
) %>%
  janitor::clean_names()
skimr::skim(mta_data)
mta_data =
  mta_data %>%
  subset(select = -c(lirr_total_estimated_ridership, lirr_percent_change_from_2019_monthly_weekday_saturday_sunday_average, metro_north_total_estimated_ridership, metro_north_percent_change_from_2019_monthly_weekday_saturday_sunday_average, access_a_ride_total_scheduled_trips, access_a_ride_percent_change_from_2019_monthly_weekday_saturday_sunday_average, bridges_and_tunnels_total_traffic, bridges_and_tunnels_percent_change_from_2019_equivalent_day))
#exclude data for lirr, metronorth, access-a-ride, bridges & tunnel

mta_data = mta_data %>%
  mutate( 
    'subway_2019' = subways_total_estimated_ridership/(1+(subways_percent_change_from_2019_equivalent_day/100)),
    'bus_2019'=
      buses_total_estimated_ridership/(1+(buses_percent_change_from_2019_equivalent_day/100))
    ) %>%
  rename(
    "subway_2020" = subways_total_estimated_ridership,
    "subway_pct_change" = subways_percent_change_from_2019_equivalent_day,
    "bus_2020" = buses_total_estimated_ridership,
    "bus_pct_change" = buses_percent_change_from_2019_equivalent_day
    )
```

```{r results='hide', message=FALSE}
#change date to date format and order by date
mta_data =
  mta_data %>%
  mutate(
    date= as.Date(date,format = "%m/%d")) %>%
  arrange(date)
#create a text_label label
text_label =
  mta_data %>%
  mutate(text_label = str_c("percent change from 2019 to 2020: ", subway_pct_change)) %>%
  select(date, text_label)

#graph for subway 
#pivoting
plot_subway = 
  mta_data %>%
  select(subway_2019, subway_2020, date) %>%
  melt(., id.vars = "date") %>%
#merge based on month 
  merge(text_label, by = "date") %>%
  #plotting
  plot_ly(
    x = ~date, y = ~value, type = "scatter", mode = "markers",
    color = ~variable, text = ~text_label) %>%
  layout (
    title = " Figure 2. Subway Ridership Trends 2019 - 2020",
    xaxis = list(title ="Month/Day", tickformat = "%m/%d"), #drop year
    yaxis = list(title="Ridership"))  %>%
  add_lines(x =as.Date("2020-03-01"), line = list(dash="dot", color = 'red', width=0.5, opacity = 0.5),name = 'First case on 3/1') %>%
  add_lines(x =as.Date("2020-04-07"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '100K cases in NYC on 04/07') %>%
  add_lines(x =as.Date("2020-05-26"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '200K cases in NYC on 05/26')
#graph for bus

#pivoting
plot_bus = 
  mta_data %>%
  select(bus_2019,bus_2020,date) %>%
  melt(., id.vars = "date") %>% 
#merge based on month 
  merge(text_label, by = "date") %>%
#plotting
  plot_ly(
    x = ~date, y = ~value, type = "scatter", mode = "markers",
    color = ~variable, text = ~text_label) %>%
  layout (
    title = " Figure 1. Bus Ridership Trends 2019 - 2020",
    xaxis = list(title ="Month/Day", tickformat = "%m/%d"),
    yaxis = list(title="Ridership")) %>%
  add_lines(x =as.Date("2020-03-01"), line = list(dash="dot", color = 'red', width=0.5, opacity = 0.5),name = 'First case on 3/1') %>%
  add_lines(x =as.Date("2020-04-07"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '100K cases in NYC on 04/07') %>%
  add_lines(x =as.Date("2020-05-26"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '200K cases in NYC on 05/26')

#ggplot for subway
plot_subway_2 = 
  mta_data %>%
  select(subway_2019, subway_2020, date) %>%
  melt(., id.vars = "date") %>%
  ggplot(aes(x=date, y=value, color=variable)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE)  +
  geom_vline(xintercept=as.Date("2020-03-01"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-04-07"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-05-26"), linetype="dotted", color = 'red')+
  geom_text(x=as.Date("2020-03-01"), y=6100000, label ="First case", angle=90, vjust = 1.2, size=3,color='black') +
  geom_text(x=as.Date("2020-04-07"), y=6100000, label ='100K cases', angle=90, vjust = 1.2, size=3,color='black')+
  geom_text(x=as.Date("2020-05-26"), y=6100000, label ='200K cases', angle=90, vjust = 1.2, size=3,color='black')
ggplotly(plot_subway_2)

#ggplot for bus
plot_bus_2 = 
  mta_data %>%
  select(bus_2019, bus_2020,date) %>%
  melt(., id.vars = "date") %>% 
  ggplot(aes(x=date, y=value, color=variable)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE) +  
  geom_vline(xintercept=as.Date("2020-03-01"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-04-07"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-05-26"), linetype="dotted", color = 'red')+
  geom_text(x=as.Date("2020-03-01"), y=2400000, label ="First case", angle=90, vjust = 1.2, size=3,color='black') +
  geom_text(x=as.Date("2020-04-07"), y=2400000, label ='100K cases', angle=90, vjust = 1.2, size=3,color='black')+
  geom_text(x=as.Date("2020-05-26"), y=2400000, label ='200K cases', angle=90, vjust = 1.2, size=3,color='black')
ggplotly(plot_bus_2)

```

```{r message=FALSE}
#see the two graphs together:
plot_bus
plot_subway
(plot_bus_2+plot_subway_2)
```

From these plots, we can see that the ridership values in March 2020 are similar to those of ridership in March 2019 for both buses and subways. However, from mid-March onward there are overall reduced ridership trends in 2020 as compared to 2019 for both forms of transit. These trends in reduced ridership align with the "New York on PAUSE" executive order, which caused many people to stop using public transportation.  

In the first plot of bus ridership trends, there appears to be a continuous drop in ridership between the first COVID-19 case on March 1, 2020 and April 1, 2020. This trend is followed by an increase in ridership in April through July 2020 and then subsequently a broadening of the range of values around August 2020, with some reductions in values and others remaining generally constant. From the 2019 estimates, we also notice many outlying lower values, produced by decreased bus ridership on Thursdays and Fridays. This is likely a result of fewer commuters on those days. 

The trends in subway ridership, as depicted by the second plot, show some similarities to the bus ridership trends, although there are fewer overlapping values when comparing the years 2019 and 2020. The increase in subway ridership, beginning around April 2020 is also less extreme than the increase in bus ridership and there is a more narrow range of values in the 2020 subway ridership as compared to bus ridership. Finally, the 2020 subway ridership does not appear to be decreasing in recent months as with bus ridership. These trends suggest that as people began to use public transportation again during the pandemic, fewer people chose to use the subway as compared to buses. 

### Additional Analysis 

We conducted a two-sample t-test to explore the difference in average subway ridership between 2019 and 2020. 

```{r, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(patchwork)
library(readr)
library(broom)
library(dbplyr)
library(viridis)
library(reshape2)
library(plotly)
library(lubridate)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))

mta_data = read_csv (file = "./data/MTA_recent_ridership_data_20201123_0.csv",
                     col_types = cols(
                       date = col_date(format = "%mm/%dd/%yy"),
                       `Subways: % Change From 2019 Equivalent Day` = col_number(),
                       `Buses: % Change From 2019 Equivalent Day` = col_number(),
                       `Bridges and Tunnels: % Change From 2019 Equivalent Day` = col_number()
                       ) #only changed the formats of important variables 
) %>%
  janitor::clean_names()
skimr::skim(mta_data)
mta_data =
  mta_data %>%
  subset(select = -c(lirr_total_estimated_ridership, lirr_percent_change_from_2019_monthly_weekday_saturday_sunday_average, metro_north_total_estimated_ridership, metro_north_percent_change_from_2019_monthly_weekday_saturday_sunday_average, access_a_ride_total_scheduled_trips, access_a_ride_percent_change_from_2019_monthly_weekday_saturday_sunday_average, bridges_and_tunnels_total_traffic, bridges_and_tunnels_percent_change_from_2019_equivalent_day))
#exclude data for lirr, metronorth, access-a-ride, bridges & tunnel

mta_data = mta_data %>%
  mutate( 
    'subway_2019' = subways_total_estimated_ridership/(1+(subways_percent_change_from_2019_equivalent_day/100)),
    'bus_2019'=
      buses_total_estimated_ridership/(1+(buses_percent_change_from_2019_equivalent_day/100))
    ) %>%
  rename(
    "subway_2020" = subways_total_estimated_ridership,
    "subway_pct_change" = subways_percent_change_from_2019_equivalent_day,
    "bus_2020" = buses_total_estimated_ridership,
    "bus_pct_change" = buses_percent_change_from_2019_equivalent_day
    )

#change date to date format and order by date
mta_data =
  mta_data %>%
  mutate(
    date= as.Date(date,format = "%m/%d")) %>%
  arrange(date)
#create a text_label label
text_label =
  mta_data %>%
  mutate(text_label = str_c("percent change from 2019 to 2020: ", subway_pct_change)) %>%
  select(date, text_label)

#graph for subway 
#pivoting
plot_subway = 
  mta_data %>%
  select(subway_2019, subway_2020, date) %>%
  melt(., id.vars = "date") %>%
#merge based on month 
  merge(text_label, by = "date") %>%
  #plotting
  plot_ly(
    x = ~date, y = ~value, type = "scatter", mode = "markers",
    color = ~variable, text = ~text_label) %>%
  layout (
    title = "Subway Ridership Trends 2019 - 2020",
    xaxis = list(title ="Month/Day", tickformat = "%m/%d"), #drop year
    yaxis = list(title="Ridership"))  %>%
  add_lines(x =as.Date("2020-03-01"), line = list(dash="dot", color = 'red', width=0.5, opacity = 0.5),name = 'First case on 3/1') %>%
  add_lines(x =as.Date("2020-04-07"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '100K cases in NYC on 04/07') %>%
  add_lines(x =as.Date("2020-05-26"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '200K cases in NYC on 05/26')
#graph for bus

#pivoting
plot_bus = 
  mta_data %>%
  select(bus_2019,bus_2020,date) %>%
  melt(., id.vars = "date") %>% 
#merge based on month 
  merge(text_label, by = "date") %>%
#plotting
  plot_ly(
    x = ~date, y = ~value, type = "scatter", mode = "markers",
    color = ~variable, text = ~text_label) %>%
  layout (
    title = "Bus Ridership Trends 2019 - 2020",
    xaxis = list(title ="Month/Day", tickformat = "%m/%d"),
    yaxis = list(title="Ridership")) %>%
  add_lines(x =as.Date("2020-03-01"), line = list(dash="dot", color = 'red', width=0.5, opacity = 0.5),name = 'First case on 3/1') %>%
  add_lines(x =as.Date("2020-04-07"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '100K cases in NYC on 04/07') %>%
  add_lines(x =as.Date("2020-05-26"), line = list(dash="dot", color = 'red', width=0.5, alpha = 0.5),name = '200K cases in NYC on 05/26')

#ggplot for subway
plot_subway_2 = 
  mta_data %>%
  select(subway_2019, subway_2020, date) %>%
  melt(., id.vars = "date") %>%
  ggplot(aes(x=date, y=value, color=variable)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE)  +
  geom_vline(xintercept=as.Date("2020-03-01"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-04-07"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-05-26"), linetype="dotted", color = 'red')+
  geom_text(x=as.Date("2020-03-01"), y=6100000, label ="First case", angle=90, vjust = 1.2, size=3,color='black') +
  geom_text(x=as.Date("2020-04-07"), y=6100000, label ='100K cases', angle=90, vjust = 1.2, size=3,color='black')+
  geom_text(x=as.Date("2020-05-26"), y=6100000, label ='200K cases', angle=90, vjust = 1.2, size=3,color='black')
ggplotly(plot_subway_2)

#ggplot for bus
plot_bus_2 = 
  mta_data %>%
  select(bus_2019, bus_2020,date) %>%
  melt(., id.vars = "date") %>% 
  ggplot(aes(x=date, y=value, color=variable)) +
  geom_point(alpha=0.5) +
  geom_smooth(se = FALSE) +  
  geom_vline(xintercept=as.Date("2020-03-01"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-04-07"), linetype="dotted", color = 'red')+
  geom_vline(xintercept=as.Date("2020-05-26"), linetype="dotted", color = 'red')+
  geom_text(x=as.Date("2020-03-01"), y=2400000, label ="First case", angle=90, vjust = 1.2, size=3,color='black') +
  geom_text(x=as.Date("2020-04-07"), y=2400000, label ='100K cases', angle=90, vjust = 1.2, size=3,color='black')+
  geom_text(x=as.Date("2020-05-26"), y=2400000, label ='200K cases', angle=90, vjust = 1.2, size=3,color='black')
ggplotly(plot_bus_2)

#see the two graphs together:
plot_bus
plot_subway
(plot_bus_2+plot_subway_2)
```

After converting the dates to an appropriate numeric format and calculating average ridership values per month, we created a dataframe to nest the observations for 2019 and 2020 subway ridership for each month. 

```{r, results='hide', message=FALSE}
#t-test set up 
#separate by month and day
mta_data = 
  mta_data %>%
  separate(date, into = c("year", "month", "day"))%>%
  mutate(month = as.numeric(month),
         day = as.numeric(day)) %>%
  select(-c(year)) #drop year column

mta_subway_ridership =
  mta_data %>%
  group_by(month)%>%
  summarize(
    avg_subway_2019 = mean(subway_2019),
    avg_subway_2020 = mean(subway_2020)
  )

mta_subway_ridership%>%knitr::kable()
mta_2019_sample = 
  mta_data%>%
  select(month, subway_2019) %>%
  nest(subway_2019)%>%
  mutate("subway_2019_sample" = data)%>%
  select(-data)

mta_2020_sample = 
  mta_data%>%
  select(month, subway_2020)%>%
  nest(subway_2020)%>%
  mutate("subway_2020_sample" = data)%>%
  select(-data)

mta_samples = 
  bind_cols(mta_2019_sample, mta_2020_sample)%>%
  select(-month...3)%>%
  rename(month = month...1)
```

Next, we performed a t-test to check if the subway ridership was significantly different between 2019 and 2020 data by mapping across each month. We then compared the p-value obtained from the tests to determine whether the difference in ridership values was significant or not.

```{r, results='hide', message=FALSE}
mta_t_test = mta_samples%>%
  mutate(t_test = map2(.x = subway_2019_sample, .y = subway_2020_sample, ~t.test(.x , .y) ),
         t_test_results = map(t_test, broom::tidy))%>%
  select(month, t_test_results)%>%
  unnest(t_test_results)%>%
  select(month,p.value)%>%
  mutate(difference = case_when(
    p.value >= 0.05 ~ "insignificant",
    p.value < 0.05 ~ "significant"),
    p.value = ifelse(
    p.value< 0.001,"<0.001",round(p.value, digits = 4))) %>%
  arrange(month) 

knitr::kable(mta_t_test, digits = 3)
```

### Table 1. T-test Results by Month

*Merged t-test results with the average ridership for each month.* 


```{r, message=FALSE}
mta_year_ttest = 
  bind_cols(mta_subway_ridership, mta_t_test)%>%
  select(-month...4)%>%
  rename(month = month...1) 
knitr::kable(mta_year_ttest) 
```

The following plot was created using the final dataframe to depict average ridership for each month comparing 2019 and 2020. The labels that appear at each data point as you hover over them provides additional information about the significance or lack of significant in ridership difference. 

### Figure 3. Monthly Average Ridership of Subway 2019 vs 2020

```{r message=FALSE}
#create a text_label label
text_label =
  mta_year_ttest %>%
  mutate(text_label = str_c("p-value: ",p.value, "\nDifference: ", difference)) %>%
  select(month, text_label)

#pivoting
plot = 
  mta_subway_ridership %>%
  rename(
    "2019"=avg_subway_2019,
    "2020"=avg_subway_2020
  ) %>%
  melt(., id.vars = "month") %>%
#merge based on month 
  merge(text_label, by = "month")

#plotting
plot %>%
plot_ly(
    x = ~month, y = ~value, type = "scatter", mode = "lines+markers",
    color = ~variable, text = ~text_label) %>%
  layout (
    xaxis = list(title ="Months",range=c(3,11)),
    yaxis = list(title="Average Ridership"))
```

The results indicate that there is a statistically significant difference between subway ridership trends in 2019 as compared to 2020 for every month.


### Discussion 







